pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
function _init()
 newstage(1)

 --newui()
end

function _draw()
 drawstage()
 --ui:draw()
end

function _update()
end

function loadelements(x,y,w,h)
 local elts={}
 
 for i=1,w do
  for j=1,h do
   local id=mget(x+i-1,y+j-1)
   newelement(elts,id,i*8-8,j*8-8)
  end 
 end
 
 return elts
end

function loadground(x,y,w,h)
 local grd={}
 
 for i=1,w do
  grd[i]={}
  
  for j=1,h do
   local id=mget(x+i-1,y+j-1)
   grd[i][j]=newgrdelement(id,i*8-8,j*8-8)
  end 
 end
 
 return grd
end

function onswitch(x,y)
 local grd=stage.ground[x][y]
 
 if (grd==nil) return false
 
 return (fget(grd.id)==2)
end
-->8
--factories

function newstage(lvl)
 local stages={
  {x=0,y=0,w=9,h=7,name="the start"}
 }

 stage=stages[lvl]
 stage.ground=loadground(stage.x,stage.y,stage.w,stage.h)
 stage.elements=loadelements(stage.x,stage.y,stage.w,stage.h)
end

function newgrdelement(id,x,y)
 if (fget(id)==1) return newwall(id,x,y)
 if (fget(id)==2) return newswitch(x,y)
end

function newelement(elts,id,x,y)
 if (fget(id)==4 or fget(id)==6) add(elts,newbox(x,y))
end

function newbox(x,y)
 return {
  x=x,
  y=y,
  draw=function()
   if onswitch(flr(x/8),flr(y/8)) then
    drawstatic(3,x,y)
   else
    drawstatic(2,x,y)
   end
  end
 }
end

function newwall(id,x,y)
 local wall={}
 
 wall.id=id
 wall.x=x
 wall.y=y
 wall.draw=function()
  drawstatic(wall.id,wall.x,wall.y)
 end
  
 return wall
end

function newswitch(x,y)
local swtc={}
 
 swtc.id=4
 swtc.x=x
 swtc.y=y
 swtc.draw=function()
  drawstatic(swtc.id,swtc.x,swtc.y)
 end
  
 return swtc
end

function newui()
 return {
  draw=drawui  
 }
end

-->8
--draw functions

function drawstage()
 local x,y=stage.x,stage.y
 local w,h=stage.w,stage.h
 local xx,yy=x+w,y+h
 
 cls(6)
 rectfill(x*8,y*8,xx*8-1,yy*8-1,5) 
 
 for i=1,w do
  for j=1,h do
   local g=stage.ground[i][j]
   if (g) g.draw()
  end
 end
 
 for elt in all(stage.elements) do
  elt.draw()
 end
end

function drawstatic(id,x,y)
 spr(id,x,y)
end

function drawground(stage)
 for i=1,stage.w do
  for j=1,stage.h do
   stage.ground[i][j]:draw(i*8,j*8)
  end
 end
end

function drawwall(id)
 return function(x,y)
  spr(id,x,y)
 end
end

function drawui()
 local infos=game:stageinfos()
 color(13)
 print(infos,3,121)
 color(7)
 print(infos,2,120)
end

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000440000999999009999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000ff00009ffff9009ffff90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000088880004ffff4004f99f40000880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000f0880f004ffff4004f44f40000880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000cc00004ffff4004ffff40000220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000c00c000444444004444440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0dddddddddddddddddddddd00dddddd00dddddddddddddd000000000000000000000000000000000000000000000000000000000000000000000000000000000
dd66666666666666666666dddd6666dddd666666666666dd00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd66666666666666d00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd66666666666666d00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd66666666666666d00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd66666666666666d00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666ddd666666666666dd00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d0dddddddddddddd000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d0dddddd0dddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666ddd6666dd6666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd666666d6666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd666666d6666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd666666d6666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd666666d6666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666ddd6666dd6666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d0dddddd0dddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dd66666666666666666666dddd6666dd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0dddddddddddddddddddddd00dddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
88888ffffff882222228888888888888888888888888888888888888888888888888888888888888888228228888228822888fff8ff888888822888888228888
88888f8888f882888828888888888888888888888888888888888888888888888888888888888888882288822888222222888fff8ff888882282888888222888
88888ffffff882888828888888888888888888888888888888888888888888888888888888888888882288822888282282888fff888888228882888888288888
88888888888882888828888888888888888888888888888888888888888888888888888888888888882288822888222222888888fff888228882888822288888
88888f8f8f8882888828888888888888888888888888888888888888888888888888888888888888882288822888822228888ff8fff888882282888222288888
888888f8f8f882222228888888888888888888888888888888888888888888888888888888888888888228228888828828888ff8fff888888822888222888888
88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
00000000dddddddddddddddddddddddddddddddddddddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000
00000000666666666666666666666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000
00000000666666666666666666666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000
00000000666666666666666666666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000
00000000666666666666666666666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000
00000000666666666666666666666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000
00000000666666666666666666666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000
000000006666666666666666dddddddddddddddd66666666dddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000
66666666666666666666666d0000000000000000d666666d0000000000000000d666666600000000000000000000000000000000000000000000000000000000
66666666666666666666666d0000000000000000d666666d0999999009999990d666666600000000000000000000000000000000000000000000000000000000
66666666666666666666666d0000000000000000d666666d09ffff9009ffff90d666666600000000000000000000000000000000000000000000000000000000
66666666666666666666666d0000000000000000d666666d04f99f4004f99f40d666666600000000000000000000000000000000000000000000000000000000
66666666666666666666666d0000000000000000d666666d04f44f4004f44f40d666666600000000000000000000000000000000000000000000000000000000
66666666666666666666666d0000000000000000d666666d04ffff4004ffff40d666666600000000000000000000000000000000000000000000000000000000
6666666666666666666666dd0000000000000000d666666d0444444004444440d666666600000000000000000000000000000000000000000000000000000000
66666666ddddddddddddddd00000000000000000d666666d0000000000000000d666666600000000000000000000000000000000000000000000000000000000
6666666d00000000000000000000000000000000d6666666dddddddddddddddd6666666600000000000000000000000017171717171717171717171700000000
6666666d00000000000000000000000000000000d666666666666666666666666666666600000000000000000000000070000000000000000000000100000000
6666666d00000000000000000000000000000000d666666666666666666666666666666600000000000000000000000010000000000000000000000700000000
6666666d00000000000000000000000000000000d666666666666666666666666666666600000000000000000000000070000000000000000000000100000000
6666666d00000000000000000000000000000000d666666666666666666666666666666600000000000000000000000010000000000000000000000700000000
6666666d00000000000000000000000000000000d666666666666666666666666666666600000000000000000000000070000000000000000000000100000000
6666666d00000000000000000000000000000000d666666666666666666666666666666600000000000000000000000010000000000000000000000700000000
6666666d00000000000000000000000000000000d6666666dddddddddddddddd6666666600000000000010000000000070000000000000000000000100000000
6666666d00000000000000000dddddd000000000d666666d0000000000000000d666666600000000000171000000000010000000000000000000000700000000
6666666d0000000009999990dd6666dd00000000d666666d0000000000000000d666666600000000000177100000000070000000000000000000000100000000
6666666d0000000009ffff90d666666d00000000d666666d0000000000000000d666666600000000000177710000000010000000000000000000000700000000
6666666d0000000004ffff40d666666d00000000d666666d0008800000088000d666666600000000000177771000000070000000000000000000000100000000
6666666d0000000004ffff40d666666d00000000d666666d0008800000088000d666666600000000000177110000000010000000000000000000000700000000
6666666d0000000004ffff40d666666d00000000d666666d0002200000022000d666666600000000000011710000000070000000000000000000000100000000
6666666d0000000004444440dd6666dd00000000dd6666dd0000000000000000d666666600000000000000000000000010000000000000000000000700000000
6666666d00000000000000000dddddd0000000000dddddd00000000000000000d666666600000000000000000000000070000000000000000000000100000000
66666666ddddddd0000000000000000000000000000000000000000000000000d666666600000000000000000000000010000000000000000000000700000000
66666666666666dd000440000999999009999990099999900000000000000000d666666600000000000000000000000070000000000000000000000100000000
666666666666666d000ff00009ffff9009ffff9009ffff900000000000000000d666666600000000000000000000000010000000000000000000000700000000
666666666666666d0088880004ffff4004ffff4004ffff400008800000088000d666666600000000000000000000000070000000000000000000000100000000
666666666666666d0f0880f004ffff4004ffff4004ffff400008800000088000d666666600000000000000000000000010000000000000000000000700000000
666666666666666d000cc00004ffff4004ffff4004ffff400002200000022000d666666600000000000000000000000070000000000000000000000100000000
666666666666666d00c00c000444444004444440044444400000000000000000d666666600000000000000000000000010000000000000000000000700000000
666666666666666d000000000000000000000000000000000000000000000000d666666600000000000000000000000071717171717171717171717100000000
666666666666666d0000000000000000000000000dddddd00000000000000000d666666600000000000000000000000000000000000000000000000000000000
666666666666666d000000000000000000000000dd6666dd0000000000000000d666666600000000000000000000000000000000000000000000000000000000
666666666666666d000000000000000000000000d666666d0000000000000000d666666600000000000000000000000000000000000000000000000000000000
666666666666666d000000000000000000000000d666666d0000000000000000d666666600000000000000000000000000000000000000000000000000000000
666666666666666d000000000000000000000000d666666d0000000000000000d666666600000000000000000000000000000000000000000000000000000000
666666666666666d000000000000000000000000d666666d0000000000000000d666666600000000000000000000000000000000000000000000000000000000
666666666666666d000000000000000000000000d666666d0000000000000000d666666600000000000000000000000000000000000000000000000000000000
666666666666666d000000000000000000000000d666666d0000000000000000d666666600000000000000000000000000000000000000000000000000000000
0000000066666666dddddddddddddddddddddddd66666666dddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000
00000000666666666666666666666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000
00000000666666666666666666666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000
00000000666666666666666666666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000
00000000666666666666666666666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000
00000000666666666666666666666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000
00000000666666666666666666666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000
00000000666666666666666666666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555555555550000000055555555555555555555555555555555555555555555555555
5555555555555555555555555d555555ddd555575757575555d5d55555555d555555550000000056666666666666555557777755555555555555555555555555
555555555555555555555555ddd55555ddd555555555555555d5d5d5555555d55555550000000056ddd6ddd6d6d6555577ddd775566666555666665556666655
55555555555555555555555ddddd5555ddd555575555575555d5d5d55555555d5555550008800056d6d6d6d6d6d6555577d7d77566dd666566ddd66566ddd665
5555555555555555555555ddddd55555ddd555555555555555ddddd555ddddddd555550008800056d6d6d6d6ddd6555577d7d775666d66656666d665666dd665
555555555555555555555d5ddd5555ddddddd55755555755d5ddddd55d5ddddd5555550002200056d6d6d6d666d6555577ddd775666d666566d666656666d665
555555555555555555555d55d55555d55555d555555555555dddddd55d55ddd55555550000000056ddd6ddd666d655557777777566ddd66566ddd66566ddd665
555555555555555555555ddd555555ddddddd55757575755555ddd555d555d555555550000000056666666666666555577777775666666656666666566666665
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555566666665ddddddd5ddddddd5ddddddd5
00000000000000000000000000000007777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000007000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000440000999999009999907000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000ff00009ffff9009ffff07000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000088880004ffff4004f99f07000880007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000f0880f004ffff4004f44f07000880007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000cc00004ffff4004ffff07000220007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000c00c000444444004444407000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000007000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0dddddddddddddddddddddd00ddddd077777777770ddddd000000000000000000000000000000000000000000000000000000000000000000000000000000000
dd66666666666666666666dddd66660000000000006666dd00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd66666666666666d00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd66666666666666d00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd66666666666666d00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd66666666666666d00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666ddd666666666666dd00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d0dddddddddddddd000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d0dddddd0dddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666ddd6666dd6666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd666666d6666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd666666d6666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd666666d6666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666dd666666d6666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666ddd6666dd6666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d0dddddd0dddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d6666666666666666666666dd666666d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dd66666666666666666666dddd6666dd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0dddddddddddddddddddddd00dddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
88282888882228228822288888282888882228222822288888888888888888888888888888888888888888888888888888888888888888888888888888888888
88282882882828828828288888282882882828282888288888888888888888888888888888888888888888888888888888888888888888888888888888888888
88828888882828828828288888222888882828282882288888888888888888888888888888888888888888888888888888888888888888888888888888888888
88282882882828828828288888882882882828282888288888888888888888888888888888888888888888888888888888888888888888888888888888888888
88282888882228222822288888222888882228222822288888888888888888888888888888888888888888888888888888888888888888888888888888888888
88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888

__gff__
0000040602000000000000000000000001010101010100000000000000000000010101010101000000000000000000000101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
2121213131213131210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2131320000230303200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2200000000202525210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2200022400330404200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2112010202020404200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2122000000130000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2121111111211111210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
